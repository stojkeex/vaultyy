<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vaulty - Your AI Financial Advisor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .hidden {
            display: none;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translateY(20px); }
            10%, 90% { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-out {
            animation: fadeInOut 4s ease-in-out forwards;
        }
        /* For blurred backdrop on modal */
        .backdrop-blur-sm {
             backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="bg-black text-gray-100 min-h-screen font-sans flex flex-col">

    <!-- Header -->
    <header id="header" class="bg-black/80 backdrop-blur-sm sticky top-0 z-20 border-b border-blue-500/20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div id="logo-button" class="flex items-center cursor-pointer">
                    <img src="/vaultylogo2.png" alt="Vaulty Logo" class="h-8 w-8 mr-2">
                    <h1 class="text-xl sm:text-2xl font-bold tracking-tight">Vaulty</h1>
                </div>
                <nav class="hidden md:flex items-center gap-4">
                    <button data-view="goals" class="header-nav-button text-base font-semibold bg-gradient-to-bl from-[#00298a] to-[#0091ff] bg-clip-text text-transparent hover:opacity-80 transition-opacity">Goals</button>
                    <button data-view="businessBuilder" class="header-nav-button text-base font-semibold bg-gradient-to-bl from-[#00298a] to-[#0091ff] bg-clip-text text-transparent hover:opacity-80 transition-opacity">Builder</button>
                    <button data-view="market" class="header-nav-button text-base font-semibold bg-gradient-to-bl from-[#00298a] to-[#0091ff] bg-clip-text text-transparent hover:opacity-80 transition-opacity">Market</button>
                </nav>
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <div class="flex items-center space-x-2">
                        <span class="hidden sm:inline text-sm font-medium text-gray-400">Plan:</span>
                        <span id="header-plan-badge" class="px-3 py-1 text-xs sm:text-sm font-semibold rounded-full bg-gray-700 text-gray-200">
                            Basic
                        </span>
                    </div>
                    <button id="pricing-button" class="hidden sm:flex items-center border border-blue-500/50 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 hover:bg-blue-500/10 text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 mr-2 text-transparent bg-clip-text bg-gradient-to-bl from-[#00298a] to-[#0091ff]"><path d="m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"/></svg> 
                        Upgrade
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow p-4 sm:p-6 md:p-8">
        <div class="max-w-7xl mx-auto">
            
            <!-- Dashboard View -->
            <div id="dashboard-view" class="animate-fade-in">
                <div class="text-center mb-10 sm:mb-12">
                    <h2 class="text-3xl sm:text-4xl md:text-5xl font-extrabold tracking-tight">Welcome to Your <span class="bg-gradient-to-bl from-[#00298a] to-[#0091ff] bg-clip-text text-transparent">Financial Future</span></h2>
                    <p class="mt-4 text-base sm:text-lg text-gray-400 max-w-2xl mx-auto">Here's a quick overview of your current financial status.</p>
                </div>

                <!-- Dashboard Analytics Section -->
                <div class="mb-10 sm:mb-12 p-0.5 bg-gradient-to-br from-[#00298a]/30 to-[#0091ff]/30 rounded-2xl">
                    <div class="bg-black w-full h-full rounded-[15px] p-6">
                        <h3 class="text-xl sm:text-2xl font-bold mb-4">Your Dashboard</h3>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Monthly Goal Progress -->
                            <div class="bg-gray-900/50 p-4 rounded-lg border border-gray-800">
                                <h4 class="font-semibold text-gray-300 mb-2">Monthly Savings Goal</h4>
                                <p class="text-2xl font-bold text-white">$750 / <span class="text-base font-medium text-gray-400">$1,000</span></p>
                                <div class="w-full bg-gray-800 rounded-full h-2.5 mt-3">
                                    <div class="bg-gradient-to-bl from-[#00298a] to-[#0091ff] h-2.5 rounded-full" style="width: 75%"></div>
                                </div>
                            </div>
                            <!-- Account Balance -->
                            <div class="bg-gray-900/50 p-4 rounded-lg border border-gray-800">
                                <h4 class="font-semibold text-gray-300 mb-2">Total Investments</h4>
                                <p class="text-2xl font-bold text-white">$12,450.78</p>
                                <p class="text-sm text-green-400 flex items-center mt-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 101.414 1.414L9 9.414V14a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd" /></svg>
                                    + 5.2% this month
                                </p>
                            </div>
                            <!-- Recent Activity -->
                            <div class="bg-gray-900/50 p-4 rounded-lg border border-gray-800">
                                <h4 class="font-semibold text-gray-300 mb-2">Recent Activity</h4>
                                <ul class="text-sm text-gray-400 space-y-2">
                                    <li class="flex justify-between"><span>Stock Purchase (TSLA)</span> <span class="text-white">-$500</span></li>
                                    <li class="flex justify-between"><span>Dividend (AAPL)</span> <span class="text-green-400">+$50.24</span></li>
                                    <li class="flex justify-between"><span>Monthly Savings</span> <span class="text-green-400">+$1000</span></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Center -->
                <div class="p-0.5 bg-gradient-to-br from-[#00298a]/30 to-[#0091ff]/30 rounded-2xl">
                    <div class="bg-black w-full h-full rounded-[15px] p-6 text-center">
                        <h3 class="text-xl sm:text-2xl font-bold mb-4">How can I help you today?</h3>
                        <p class="text-gray-400 text-sm sm:text-base mb-6">Start by asking a question below, or use one of our dedicated tools.</p>
                        
                        <form id="dashboard-query-form">
                            <div class="flex flex-col sm:flex-row items-center bg-gray-900 rounded-lg p-2 border border-gray-700 focus-within:border-blue-500 gap-2 max-w-3xl mx-auto">
                                <input type="text" name="customQuery" placeholder="e.g., 'How can I save for a house down payment in 5 years?'" class="w-full bg-transparent text-white placeholder-gray-500 focus:outline-none px-3" />
                                <button type="submit" class="w-full sm:w-auto bg-gradient-to-bl from-[#00298a] to-[#0091ff] text-white font-bold py-2 px-6 rounded-md hover:opacity-90 transition-opacity flex-shrink-0">Generate</button>
                            </div>
                        </form>
                         <div class="flex items-center justify-center gap-4 mt-4">
                            <button data-view="goals" class="dashboard-action-button text-sm font-semibold text-gray-400 hover:text-white transition-colors">Analyze Goals</button>
                            <span class="text-gray-600">|</span>
                            <button data-view="businessBuilder" class="dashboard-action-button text-sm font-semibold text-gray-400 hover:text-white transition-colors">Business Builder</button>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Advisor (Chat) View -->
            <div id="advisor-view" class="hidden">
                <!-- Content is dynamically generated -->
            </div>

            <!-- Goals View -->
            <div id="goals-view" class="hidden">
                 <!-- Content is dynamically generated -->
            </div>

             <!-- Business Builder View -->
            <div id="business-builder-view" class="hidden">
                 <!-- Content is dynamically generated -->
            </div>
            
            <!-- Market View -->
            <div id="market-view" class="hidden">
                 <!-- Content is dynamically generated -->
            </div>

            <!-- Pricing View -->
            <div id="pricing-view" class="hidden">
                <!-- Content is dynamically generated -->
            </div>

        </div>
    </main>

    <!-- Coin Detail Modal -->
    <div id="coin-detail-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-30 flex items-center justify-center p-4">
        <!-- Modal content is dynamically generated -->
    </div>

    <!-- Notification -->
    <div id="notification-container" class="fixed bottom-5 right-5 z-50">
         <!-- Notifications are dynamically added here -->
    </div>


    <script>
        // --- STATE MANAGEMENT ---
        let state = {
            currentView: 'dashboard',
            selectedPlan: 'Basic',
            conversation: [],
            isLoading: false,
            error: null,
            marketData: null,
            bbState: { // Business Builder State
                step: 'intro', // intro, questioning, generating, result
                currentQuestionIndex: 0,
                answers: {},
            }
        };

        // --- GLOBAL VARS ---
        let typewriterIntervals = []; // To manage multiple intervals
        let activeChart = null;

        const planFeatures = {
            Basic: { name: 'Basic', price: '0', features: ['General financial tips', 'Limited AI analysis', 'Standard support'] },
            Pro: { name: 'Pro', price: '14.99', features: ['Personalized financial plans', 'In-depth investment analysis', 'Priority support', 'Goal tracking'] },
            Max: { name: 'Max', price: '99.99', features: ['Everything in Pro', 'Full AI intellectual capabilities', 'Custom wealth strategies', 'Market sentiment analysis', 'Dedicated AI mentor'] },
        };
        
        // --- DOM ELEMENTS ---
        const views = {
            dashboard: document.getElementById('dashboard-view'),
            advisor: document.getElementById('advisor-view'),
            goals: document.getElementById('goals-view'),
            businessBuilder: document.getElementById('business-builder-view'),
            market: document.getElementById('market-view'),
            pricing: document.getElementById('pricing-view'),
        };

        const headerPlanBadge = document.getElementById('header-plan-badge');
        const notificationContainer = document.getElementById('notification-container');
        const coinDetailModal = document.getElementById('coin-detail-modal');
        
        // --- UTILS & HELPERS (DEFINED BEFORE USAGE) ---
        function showNotification(message) {
            const id = `notif-${Date.now()}`;
            const notifElement = document.createElement('div');
            notifElement.id = id;
            notifElement.className = 'bg-gray-800 text-white py-2 px-4 rounded-lg shadow-lg flex items-center z-50 animate-fade-in-out';
            notifElement.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2 text-blue-400"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                <span class="text-sm sm:text-base">${message}</span>
            `;
            notificationContainer.appendChild(notifElement);

            setTimeout(() => {
                const el = document.getElementById(id);
                if (el) el.remove();
            }, 4000);
        }

        function clearTypewriters() {
            typewriterIntervals.forEach(clearInterval);
            typewriterIntervals = [];
        }

        function typewriter(element, text, speed, onComplete) {
            let i = 0;
            if(!element) return;
            element.innerHTML = '';
            const intervalId = setInterval(() => {
                if (i >= text.length) {
                    clearInterval(intervalId);
                    if (onComplete) onComplete();
                } else {
                    i++;
                    element.innerHTML = text.substring(0, i);
                }
            }, speed);
            typewriterIntervals.push(intervalId);
        }
        
        function simpleMarkdownRenderer(text) {
             if (!text) return '';
             return text
                .replace(/^### (.*$)/gim, '<h3 class="text-lg sm:text-xl font-semibold mt-4 mb-2 text-white">$1</h3>')
                .replace(/\*\*(.*?)\*\*/g, '<strong class="font-bold text-white">$1</strong>')
                .replace(/\*(.*?)\*/g, '<em class="italic text-blue-300">$1</em>')
                .replace(/(\r\n|\n|\r)/g, "<br />");
        }

        function planToString(planData) {
            let text = `${planData.title}\n\n${planData.summary}\n\n`;
            if (planData.actionableSteps) {
                text += "Actionable Steps:\n";
                planData.actionableSteps.forEach(step => {
                    text += `- ${step.title}: ${step.description}\n`;
                });
                text += "\n";
            }
            if (planData.potentialRisks) {
                text += "Potential Risks:\n";
                planData.potentialRisks.forEach(risk => {
                    text += `- ${risk.title}: ${risk.description}\n`;
                });
                text += "\n";
            }
            if (planData.longTermOutlook) {
                text += `Long-Term Outlook: ${planData.longTermOutlook}\n\n`;
            }
            text += `Disclaimer: ${planData.disclaimer}`;
            return text;
        }

        function formatPrice(price) {
            if (price === null || price === undefined) return 'N/A';
            if (price < 1) {
                return '$' + price.toFixed(6); // Show more decimal places for very small prices
            }
            return '$' + price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // --- HTML TEMPLATE GENERATORS ---
        function getLoadingIndicatorHTML() { return `<div class="flex items-center justify-start"><div class="bg-gray-900/50 p-3 sm:p-4 rounded-2xl flex items-center space-x-3 border border-gray-800"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 animate-spin bg-gradient-to-bl from-[#00298a] to-[#0091ff] bg-clip-text text-transparent"><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></svg><span class="text-gray-300 text-sm sm:text-base">Vaulty Thinking...</span></div></div>`; }
        function getErrorMessageHTML(msg) { return `<div class="flex items-center justify-start"><div class="bg-red-900/50 p-3 sm:p-4 rounded-2xl flex items-center space-x-3 border border-red-500/30"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-red-400"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg><span class="text-red-300 text-sm sm:text-base">Error: ${msg}</span></div></div>`; }

        function getBotActionsHTML(textToProcess) {
            return `
                <div class="mt-4 pt-2 border-t border-gray-800 flex items-center space-x-1 sm:space-x-2">
                    <button data-action="copy" class="bot-action text-gray-500 hover:text-white p-2 rounded-full transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg></button>
                    <button data-action="speak" class="bot-action text-gray-500 hover:text-white p-2 rounded-full transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg></button>
                    <div class="flex-grow"></div>
                    <button data-action="feedback-positive" class="bot-action text-gray-500 hover:text-white p-2 rounded-full transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path></svg></button>
                    <button data-action="feedback-negative" class="bot-action text-gray-500 hover:text-white p-2 rounded-full transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M10 15v5a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zM17 2H20a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2h-3"/></svg></button>
                     <textarea class="hidden">${textToProcess}</textarea>
                </div>`;
        }

        function getUserMessageHTML(content) {
            return `
                <div class="flex justify-end">
                    <div class="bg-gradient-to-br from-[#00298a] to-[#0091ff] p-3 sm:p-4 rounded-2xl max-w-[80%] sm:max-w-2xl flex items-start space-x-3 shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-white flex-shrink-0 mt-1"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        <p class="text-white whitespace-pre-wrap text-sm sm:text-base">${content}</p>
                    </div>
                </div>
            `;
        }
        
        function getBotChatMessageHTML(content) {
             return `
                <div class="flex justify-start">
                     <div class="bg-gray-900/50 p-3 sm:p-4 rounded-2xl max-w-[80%] sm:max-w-2xl flex flex-col border border-gray-800">
                        <div class="flex items-start space-x-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 bg-gradient-to-bl from-[#00298a] to-[#0091ff] bg-clip-text text-transparent flex-shrink-0 mt-1"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>
                            <div class="text-gray-300 flex-1 text-sm sm:text-base">
                                ${simpleMarkdownRenderer(content)}
                            </div>
                        </div>
                        ${getBotActionsHTML(content)}
                    </div>
                </div>
            `;
        }
        
        function getBotPlanMessageHTML(data) {
             const textVersion = planToString(data);
             let actionableStepsHTML = '';
             if (data.actionableSteps && data.actionableSteps.length > 0) {
                 data.actionableSteps.forEach(step => {
                     actionableStepsHTML += `
                        <div class="bg-black/50 p-3 sm:p-4 rounded-lg flex items-start">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 text-blue-400 mr-3 mt-1 flex-shrink-0"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                            <div>
                                <h4 class="font-bold text-sm sm:text-base">${step.title}</h4>
                                <div class="text-gray-400 text-sm">${simpleMarkdownRenderer(step.description)}</div>
                            </div>
                        </div>`;
                 });
             }
             // Similar loops for risks, etc.
             
             return `
                <div class="bg-gray-900/50 border border-gray-800 rounded-2xl p-4 sm:p-6 animate-slide-up">
                    <div class="flex items-center mb-4">
                        <span class="p-2 bg-gray-900 rounded-full mr-3"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 bg-gradient-to-bl from-[#00298a] to-[#0091ff] bg-clip-text text-transparent"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg></span>
                        <h2 class="text-xl sm:text-2xl font-bold text-white">${data.title}</h2>
                    </div>
                    <div class="space-y-6">
                        <div class="text-gray-300 text-base sm:text-lg leading-relaxed">${simpleMarkdownRenderer(data.summary)}</div>
                        ${actionableStepsHTML ? `<div><h3 class="text-lg sm:text-xl font-semibold mb-3 bg-gradient-to-bl from-[#00298a] to-[#0091ff] bg-clip-text text-transparent inline-block">Actionable Steps</h3><div class="space-y-3">${actionableStepsHTML}</div></div>` : ''}
                        <div class="mt-6 text-xs sm:text-sm text-gray-500 border-t border-gray-800 pt-4">
                            <p><strong>Disclaimer:</strong> ${data.disclaimer}</p>
                        </div>
                    </div>
                    ${getBotActionsHTML(textVersion)}
                </div>
            `;
        }

        // --- EVENT ATTACHMENT ---
        function attachBotActionListeners() {
            document.querySelectorAll('.bot-action').forEach(button => {
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
                
                newButton.addEventListener('click', (e) => {
                    const action = e.currentTarget.dataset.action;
                    const text = e.currentTarget.parentElement.querySelector('textarea').value;
                    
                    if (action === 'copy') {
                        navigator.clipboard.writeText(text);
                        showNotification("Copied to clipboard!");
                    } else if (action === 'speak') {
                       // TTS logic - placeholder
                    } else if (action.startsWith('feedback')) {
                        const type = action.split('-')[1];
                        e.currentTarget.querySelector('svg').classList.add('text-blue-500');
                        e.currentTarget.parentElement.querySelectorAll('button[data-action^="feedback"]').forEach(btn => btn.disabled = true);
                        showNotification("Thanks for your feedback!");
                    }
                });
            });
        }
        
        // --- NAVIGATION & MAIN RENDER LOGIC ---
        
        async function fetchMarketData() {
            state.isLoading = true;
            render(); // Show loading state in the market view

            try {
                const response = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=50&page=1&sparkline=false');
                if (!response.ok) {
                    throw new Error(`CoinGecko API Error: ${response.status}`);
                }
                const data = await response.json();
                state.marketData = data;
                localStorage.setItem('vaultyMarketCache', JSON.stringify({ timestamp: Date.now(), data: data }));
            } catch (e) {
                console.error("Failed to fetch from CoinGecko:", e);
                showNotification("Could not fetch live data. Showing cached data if available.");
                const cached = localStorage.getItem('vaultyMarketCache');
                if (cached) {
                    state.marketData = JSON.parse(cached).data;
                } else {
                    state.error = "Could not fetch market data. Please try again later.";
                }
            } finally {
                state.isLoading = false;
                render(); // Re-render with data or error
            }
        }
        
        async function openCoinModal(coinId) {
            coinDetailModal.classList.remove('hidden');
            coinDetailModal.innerHTML = `<div class="bg-gray-900/50 p-8 rounded-2xl border border-gray-800 text-center">Loading coin details...</div>`;

            try {
                // Fetch full coin data
                const response = await fetch(`https://api.coingecko.com/api/v3/coins/${coinId}?localization=false&tickers=false&market_data=true&community_data=false&developer_data=false&sparkline=true`);
                if (!response.ok) throw new Error('Failed to fetch coin details.');
                const coin = await response.json();

                // Prepare data for rendering
                const description = coin.description?.en?.split('. ')[0] + '.' || 'No description available.';
                const genesisDate = coin.genesis_date ? new Date(coin.genesis_date).toLocaleDateString() : 'N/A';
                const priceChange = coin.market_data.price_change_percentage_24h;
                const priceChangeColor = priceChange >= 0 ? 'text-green-400' : 'text-red-400';
                
                // Build links
                let linksHTML = '';
                if(coin.links?.homepage?.[0]) linksHTML += `<a href="${coin.links.homepage[0]}" target="_blank" class="text-blue-400 hover:underline">Website</a>`;
                if(coin.links?.twitter_screen_name) linksHTML += ` • <a href="https://x.com/${coin.links.twitter_screen_name}" target="_blank" class="text-blue-400 hover:underline">X (Twitter)</a>`;
                
                // Build modal HTML
                coinDetailModal.innerHTML = `
                    <div class="bg-black w-full max-w-2xl rounded-2xl p-6 border border-gray-800 relative animate-fade-in">
                        <button id="modal-close-button" class="absolute top-4 right-4 text-gray-500 hover:text-white transition-colors">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                        <div class="flex items-center mb-4">
                            <img src="${coin.image.large}" class="w-12 h-12 rounded-full mr-4">
                            <div>
                                <h3 class="text-2xl font-bold">${coin.name} <span class="uppercase text-gray-400">${coin.symbol}</span></h3>
                                <p class="text-3xl font-bold font-mono">${formatPrice(coin.market_data.current_price.usd)} <span class="${priceChangeColor} text-lg">(${priceChange.toFixed(2)}%)</span></p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-sm mb-4">
                            <div class="bg-gray-900/50 p-3 rounded-lg"><span class="text-gray-400">24h High:</span> ${formatPrice(coin.market_data.high_24h.usd)}</div>
                            <div class="bg-gray-900/50 p-3 rounded-lg"><span class="text-gray-400">24h Low:</span> ${formatPrice(coin.market_data.low_24h.usd)}</div>
                        </div>
                        <div class="w-full h-48 mb-4"><canvas id="coinChart"></canvas></div>
                        <div class="text-left text-sm space-y-4">
                            <p>${description}</p>
                            <p><strong class="text-gray-400">Genesis Date:</strong> ${genesisDate}</p>
                            <div class="text-blue-400">${linksHTML}</div>
                        </div>
                        <button id="modal-analyze-button" class="mt-6 w-full bg-gradient-to-bl from-[#00298a] to-[#0091ff] text-white font-bold py-3 px-6 rounded-md hover:opacity-90 transition-opacity">
                            Analyze with AI
                        </button>
                    </div>
                `;

                // Initialize Chart
                const ctx = document.getElementById('coinChart').getContext('2d');
                if (activeChart) activeChart.destroy();
                
                const priceData = coin.market_data.sparkline_7d.price;
                const labels = Array.from(Array(priceData.length).keys());
                
                activeChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Price (USD)',
                            data: priceData,
                            borderColor: 'rgba(0, 145, 255, 0.8)',
                            backgroundColor: 'rgba(0, 145, 255, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.4,
                            fill: true,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { x: { display: false }, y: { display: false } },
                        plugins: { legend: { display: false } }
                    }
                });

                document.getElementById('modal-close-button').addEventListener('click', closeCoinModal);
                document.getElementById('modal-analyze-button').addEventListener('click', () => {
                    const prompt = `Analyze the cryptocurrency ${coin.name} (${coin.symbol}). Current price is ${formatPrice(coin.market_data.current_price.usd)}. Here is a brief description: ${description}`;
                    closeCoinModal();
                    handleNavigate('advisor');
                    setTimeout(() => handleGenerateResponse(prompt, 'chat'), 10);
                });

            } catch(e) {
                 coinDetailModal.innerHTML = `<div class="bg-gray-900/50 p-8 rounded-2xl border border-gray-800 text-center">${getErrorMessageHTML(e.message)}</div>`;
                 setTimeout(closeCoinModal, 3000);
            }
        }

        function closeCoinModal() {
            if (activeChart) {
                activeChart.destroy();
                activeChart = null;
            }
            coinDetailModal.classList.add('hidden');
            coinDetailModal.innerHTML = '';
        }

        function handleNavigate(view) {
            state.currentView = view;
            state.conversation = [];
            window.scrollTo(0, 0); 
            state.bbState = { step: 'intro', currentQuestionIndex: 0, answers: {} };
            clearTypewriters();
            
            if (view === 'market') {
                fetchMarketData();
            } else {
                render();
            }
        }

        async function handleGenerateResponse(prompt, responseType = 'chat', isBusinessPlan = false) {
             if (!prompt) return;

            state.isLoading = true;
            state.error = null;
            const userMessage = { type: 'user', content: prompt };

            if (isBusinessPlan) {
                state.conversation = [];
            } else {
                state.conversation.push(userMessage);
            }
            render();

            const apiKey = "AIzaSyAVsgP4wvcrkhZchKlv3-5WJEqGW_i-fmU"; // <--- ADD YOUR API KEY BETWEEN THE QUOTES
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            let systemPrompt;
            let payload;

            if (responseType === 'chat') {
                systemPrompt = `You are "Vaulty AI," a friendly and conversational AI financial assistant. Your goal is to provide helpful and clear answers to financial questions. Use Markdown for formatting, including **bold**, *italic*, and ### headers to structure your response nicely. Keep the tone encouraging and professional. The user is on the "${state.selectedPlan}" plan, so tailor the depth and detail of your response accordingly. You are not a licensed financial advisor, so always include a brief disclaimer if you are providing financial advice.`;
                payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };
            } else { // 'plan'
                systemPrompt = isBusinessPlan 
                    ? `You are "Vaulty AI," a world-class AI business strategy consultant. Your goal is to provide a comprehensive and actionable business plan based on the user's answers. Structure the plan with sections for Concept, Budget Allocation, Target Audience, Marketing, and Next Steps. The user is on the "${state.selectedPlan}" plan. Tailor the depth of your response accordingly. Use Markdown for formatting, including **bold**, *italic*, and ### headers. DO NOT use markdown lists (like - or *), use standard newlines instead. ALWAYS include a disclaimer that this is a conceptual plan and professional consultation is advised.`
                    : `You are "Vaulty AI," a world-class AI financial advisor. Your goal is to provide structured, actionable, and insightful financial plans. You are NOT a licensed financial advisor. ALWAYS include a clear disclaimer that your advice is for informational purposes only and users should consult a professional. Based on the user's request, generate a detailed financial strategy. Use Markdown for formatting, including **bold**, *italic*, and ### headers. DO NOT use markdown lists (like - or *), use standard newlines instead. Adhere strictly to the JSON schema provided. The user is on the "${state.selectedPlan}" plan. Tailor the depth of your response accordingly.`;
                payload = { 
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: { title: { type: "STRING" }, summary: { type: "STRING" }, actionableSteps: { type: "ARRAY", items: { type: "OBJECT", properties: { title: { type: "STRING" }, description: { type: "STRING" } } } }, potentialRisks: { type: "ARRAY", items: { type: "OBJECT", properties: { title: { type: "STRING" }, description: { type: "STRING" } } } }, longTermOutlook: { type: "STRING" }, disclaimer: { type: "STRING" } },
                            required: ["title", "summary", "actionableSteps", "disclaimer"]
                        }
                    }
                };
            }

            try {
                if (!apiKey) throw new Error("API key is missing. Please add it to the code.");
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.status} ${response.statusText}`);
                const result = await response.json();
                const candidate = result.candidates?.[0];
                const responseText = candidate?.content?.parts?.[0]?.text;

                let botMessage;
                if (responseType === 'chat') {
                    botMessage = { type: 'bot', format: 'chat', content: responseText || "I'm sorry, I can only assist with questions related to finance, money, investing, or business." };
                } else {
                    const parsedJson = JSON.parse(responseText || '{}');
                    if (Object.keys(parsedJson).length === 0) throw new Error("Failed to generate a valid plan.");
                    botMessage = { type: 'bot', format: 'plan', content: parsedJson };
                }
                state.conversation.push(botMessage);

            } catch (e) {
                console.error(e);
                state.error = e.message;
                const errorMessage = { type: 'bot', format: 'chat', content: `Sorry, an error occurred: ${e.message}` };
                state.conversation.push(errorMessage);
            } finally {
                state.isLoading = false;
                if (isBusinessPlan) {
                    state.bbState.step = 'result';
                }
                render();
            }
        }

        // --- VIEW RENDERERS ---
        function renderAdvisorView() {
            views.advisor.innerHTML = `
                <div class="animate-fade-in flex flex-col h-[calc(100vh-12rem)] relative">
                     <div class="flex-shrink-0 flex justify-end">
                        <button id="advisor-close-button" class="p-2 text-gray-500 hover:text-white transition-colors absolute top-0 right-0 z-10">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </div>
                    <div id="chat-container" class="flex-grow space-y-6 sm:space-y-8 overflow-y-auto pr-2 sm:pr-4 pb-24 pt-8">
                       
                    </div>
                    <div class="absolute bottom-0 left-0 right-0 bg-black/80 backdrop-blur-sm p-2 sm:p-4 border-t border-blue-500/20">
                        <div class="max-w-4xl mx-auto">
                            <form id="advisor-form">
                                <div class="flex items-center bg-gray-900 rounded-lg p-2 border border-gray-800 focus-within:border-blue-500 shadow-lg">
                                    <input type="text" id="advisor-input" placeholder="Ask a follow-up question..." class="w-full bg-transparent text-white placeholder-gray-500 focus:outline-none px-3 py-2" ${state.isLoading ? 'disabled' : ''} />
                                    <button type="submit" id="advisor-submit" class="bg-gradient-to-bl from-[#00298a] to-[#0091ff] text-white font-bold py-2 px-4 sm:px-6 rounded-md hover:opacity-90 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed" ${state.isLoading ? 'disabled' : ''}>
                                      ${state.isLoading ? '...' : 'Send'}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            const chatContainer = document.getElementById('chat-container');
            if (state.conversation.length === 0) {
                 chatContainer.innerHTML = `<div class="text-center text-gray-500 pt-16">Start the conversation...</div>`;
            } else {
                 state.conversation.forEach(msg => {
                    const msgElement = document.createElement('div');
                    if (msg.type === 'user') {
                        msgElement.innerHTML = getUserMessageHTML(msg.content);
                    } else if (msg.format === 'chat') {
                         msgElement.innerHTML = getBotChatMessageHTML(msg.content);
                    } else if (msg.format === 'plan') {
                         msgElement.innerHTML = getBotPlanMessageHTML(msg.content);
                    }
                    chatContainer.appendChild(msgElement);
                });
            }
            
            if (state.isLoading) chatContainer.innerHTML += getLoadingIndicatorHTML();
            if (state.error) chatContainer.innerHTML += getErrorMessageHTML(state.error);

            chatContainer.scrollTop = chatContainer.scrollHeight;
            document.getElementById('advisor-close-button').addEventListener('click', () => handleNavigate('dashboard'));
            document.getElementById('advisor-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const input = document.getElementById('advisor-input');
                if (input.value.trim()){
                    handleGenerateResponse(input.value, 'chat');
                    input.value = '';
                }
            });
            attachBotActionListeners();
        }

        function renderGoalsView() {
            const goalsData = [ { id: 1, name: 'Buy a Dream Car', amount: 50000, saved: 12000 }, { id: 2, name: 'House Down Payment', amount: 100000, saved: 25000 } ];
            
            let goalsHTML = '';
            goalsData.forEach(goal => {
                const progress = (goal.saved / goal.amount) * 100;
                const remaining = goal.amount - goal.saved;
                const prompt = `Create a plan to help me save the remaining $${remaining.toLocaleString()} for my goal: '${goal.name}'. I've already saved $${goal.saved.toLocaleString()}.`;

                goalsHTML += `
                    <div class="bg-gray-900/50 p-4 sm:p-6 rounded-2xl border border-gray-800">
                        <div class="flex flex-col sm:flex-row flex-wrap justify-between items-start sm:items-center gap-4">
                            <div>
                                <h3 class="text-lg sm:text-xl font-bold">${goal.name}</h3>
                                <p class="text-sm text-gray-400">Target: $${goal.amount.toLocaleString()} | Saved: $${goal.saved.toLocaleString()}</p>
                            </div>
                            <button data-prompt="${prompt}" class="analyze-goal-button border border-blue-500/50 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-500/10 transition-colors w-full sm:w-auto">
                                Analyze with AI
                            </button>
                        </div>
                        <div class="w-full bg-gray-800 rounded-full h-2.5 mt-4">
                            <div class="bg-gradient-to-bl from-[#00298a] to-[#0091ff] h-2.5 rounded-full" style="width: ${progress}%"></div>
                        </div>
                        <p class="text-right text-sm text-gray-400 mt-1">${Math.round(progress)}% Complete</p>
                    </div>
                `;
            });

            views.goals.innerHTML = `
                <div class="animate-fade-in">
                    <button id="goals-back-button" class="mb-6 font-semibold flex items-center text-blue-300 hover:text-blue-200">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-2 transform rotate-180"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg> Back to Dashboard
                    </button>
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                        <h2 class="text-2xl sm:text-3xl font-bold">Your Financial Goals</h2>
                        <button class="flex items-center bg-gradient-to-bl from-[#00298a] to-[#0091ff] text-white font-bold py-2 px-4 rounded-lg transition-colors hover:opacity-90 w-full sm:w-auto">
                           <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg> Add New Goal
                        </button>
                    </div>
                    <div class="space-y-4">${goalsHTML}</div>
                </div>
            `;
            document.getElementById('goals-back-button').addEventListener('click', () => handleNavigate('dashboard'));
            document.querySelectorAll('.analyze-goal-button').forEach(button => {
                button.addEventListener('click', () => {
                    const prompt = button.dataset.prompt;
                    handleNavigate('advisor');
                    setTimeout(() => handleGenerateResponse(prompt, 'plan'), 10);
                });
            });
        }
        
        function renderBusinessBuilderView() {
            let contentHTML = '';
            const { step, currentQuestionIndex } = state.bbState;

            const questions = [
                "What is the core idea or concept of your business?",
                "What is your estimated starting budget? (e.g., $5,000, $50,000)",
                "Who is your target audience or ideal customer?",
                "What makes your business unique compared to competitors?"
            ];

            switch(step) {
                case 'intro':
                    contentHTML = `
                        <div class="text-center p-4 sm:p-8">
                            <p id="bb-intro-text" class="text-xl sm:text-2xl md:text-3xl font-semibold min-h-[84px]"></p>
                            <button id="bb-start-button" class="hidden mt-8 bg-gradient-to-bl from-[#00298a] to-[#0091ff] text-white font-bold py-3 px-8 sm:py-4 sm:px-10 rounded-lg text-lg sm:text-xl animate-fade-in">
                                Let's Start
                            </button>
                        </div>
                    `;
                    break;
                case 'questioning':
                    contentHTML = `
                         <div class="p-4 sm:p-8 text-center">
                            <div class="mb-8">
                                <span class="font-semibold bg-gradient-to-bl from-[#00298a] to-[#0091ff] bg-clip-text text-transparent">Question ${currentQuestionIndex + 1} of ${questions.length}</span>
                                <p id="bb-question-text" class="text-2xl sm:text-3xl md:text-4xl mt-4 min-h-[100px] font-semibold"></p>
                            </div>
                            <form id="bb-answer-form" class="hidden animate-fade-in">
                                <div class="flex items-center bg-gray-900 rounded-lg p-2 border border-gray-700 focus-within:border-blue-500 max-w-2xl mx-auto">
                                    <input name="answer" type="text" placeholder="Type your answer here..." class="w-full bg-transparent text-white placeholder-gray-500 focus:outline-none px-3 py-2" required />
                                    <button type="submit" class="bg-gradient-to-bl from-[#00298a] to-[#0091ff] text-white font-bold py-2 px-6 rounded-md hover:opacity-90 transition-opacity">
                                        Send <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 inline-block ml-1"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                                    </button>
                                </div>
                            </form>
                        </div>
                    `;
                    break;
                case 'generating':
                    contentHTML = `
                        <div class="text-center p-10 sm:p-16 animate-pulse">
                            <h2 class="text-3xl sm:text-4xl md:text-5xl font-bold bg-gradient-to-bl from-[#00298a] to-[#0091ff] bg-clip-text text-transparent">
                                Vaulty is generating your plan!
                            </h2>
                        </div>`;
                    break;
                case 'result':
                    const plan = state.conversation[0]?.content;
                    contentHTML = plan ? getBotPlanMessageHTML(plan) : getErrorMessageHTML('Failed to load the business plan.');
                    break;
            }

            views.businessBuilder.innerHTML = `
                 <div class="animate-fade-in max-w-4xl mx-auto">
                    <button id="bb-back-button" class="mb-6 font-semibold flex items-center text-blue-300 hover:text-blue-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-2 transform rotate-180"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg> Back to Dashboard
                    </button>
                    <div id="bb-content">${contentHTML}</div>
                </div>
            `;

            document.getElementById('bb-back-button').addEventListener('click', () => handleNavigate('dashboard'));
            
            if (step === 'intro') {
                const introTextEl = document.getElementById('bb-intro-text');
                const startBtn = document.getElementById('bb-start-button');
                typewriter(introTextEl, "Welcome! I'm your Business Builder! Do you want to start our experience?", 30, () => {
                    startBtn.classList.remove('hidden');
                });
                startBtn.addEventListener('click', () => {
                    state.bbState.step = 'questioning';
                    render();
                });
            } else if (step === 'questioning') {
                const questionTextEl = document.getElementById('bb-question-text');
                const answerForm = document.getElementById('bb-answer-form');
                typewriter(questionTextEl, questions[currentQuestionIndex], 30, () => {
                    answerForm.classList.remove('hidden');
                    answerForm.querySelector('input').focus();
                });
                answerForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    state.bbState.answers[currentQuestionIndex] = e.target.elements.answer.value;
                    if (currentQuestionIndex < questions.length - 1) {
                        state.bbState.currentQuestionIndex++;
                        render();
                    } else {
                        state.bbState.step = 'generating';
                        const finalPrompt = `Create a business plan with these details:\n- Concept: ${state.bbState.answers[0]}\n- Budget: ${state.bbState.answers[1]}\n- Target Audience: ${state.bbState.answers[2]}\n- Uniqueness: ${state.bbState.answers[3]}`; 
                        handleGenerateResponse(finalPrompt, 'plan', true);
                    }
                });
            } else if (step === 'result') {
                 attachBotActionListeners();
            }
        }
        
        function renderMarketView(filteredData) {
            const coins = filteredData || state.marketData;
            let tableRowsHTML = '';
            if (coins) {
                coins.forEach(coin => {
                    const priceChange = coin.price_change_percentage_24h;
                    const priceChangeColor = priceChange >= 0 ? 'text-green-400' : 'text-red-400';
                    tableRowsHTML += `
                        <tr data-coin-id="${coin.id}" class="market-row border-b border-gray-800 hover:bg-gray-900/50 cursor-pointer">
                            <td class="p-4"><img src="${coin.image}" alt="${coin.name}" class="w-8 h-8 rounded-full"></td>
                            <td class="p-4 font-bold">${coin.name} <span class="text-gray-400 font-normal uppercase">${coin.symbol}</span></td>
                            <td class="p-4 font-mono">${formatPrice(coin.current_price)}</td>
                            <td class="p-4 font-mono ${priceChangeColor}">${priceChange ? priceChange.toFixed(2) : 'N/A'}%</td>
                            <td class="p-4 font-mono hidden sm:table-cell">$${coin.market_cap.toLocaleString()}</td>
                        </tr>
                    `;
                });
            }

            views.market.innerHTML = `
                <div class="animate-fade-in">
                    <h2 class="text-3xl font-bold mb-2">Crypto Market</h2>
                    <p class="text-gray-400 mb-6">Live data from the top 50 cryptocurrencies.</p>
                    <div class="mb-6">
                        <input id="market-search" type="text" placeholder="Search for any coin..." class="w-full bg-gray-900/50 border border-gray-800 rounded-lg p-3 focus:outline-none focus:border-blue-500 transition-colors">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="border-b border-gray-700 text-sm text-gray-400 uppercase">
                                    <th class="p-4"></th>
                                    <th class="p-4">Name</th>
                                    <th class="p-4">Price</th>
                                    <th class="p-4">24h %</th>
                                    <th class="p-4 hidden sm:table-cell">Market Cap</th>
                                </tr>
                            </thead>
                            <tbody id="market-table-body">
                                ${state.isLoading ? '<tr><td colspan="5" class="text-center p-8"><div class="flex justify-center items-center">Loading market data...</div></td></tr>' : tableRowsHTML}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            document.getElementById('market-search').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                if (!state.marketData) return;
                const filtered = state.marketData.filter(c => 
                    c.name.toLowerCase().includes(searchTerm) || 
                    c.symbol.toLowerCase().includes(searchTerm)
                );
                renderMarketView(filtered);
            });

            document.querySelectorAll('.market-row').forEach(row => {
                row.addEventListener('click', () => openCoinModal(row.dataset.coinId));
            });
        }


        function renderPricingView() {
            views.pricing.innerHTML = `
                <div class="animate-fade-in">
                    <button id="pricing-back-button" class="mb-6 font-semibold flex items-center text-blue-300 hover:text-blue-200">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-2 transform rotate-180"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg> Back to Dashboard
                    </button>
                     <div class="text-center mb-10 sm:mb-12">
                        <h2 class="text-3xl sm:text-4xl md:text-5xl font-extrabold tracking-tight">Find the Perfect Plan for <span class="bg-gradient-to-bl from-[#00298a] to-[#0091ff] bg-clip-text text-transparent">Vaulty</span></h2>
                        <p class="mt-4 text-base sm:text-lg text-gray-400 max-w-2xl mx-auto">Unlock your financial potential with the right set of tools.</p>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 sm:gap-8 max-w-5xl mx-auto">
                    </div>
                </div>
            `;
            const pricingContainer = views.pricing.querySelector('.grid');
            Object.values(planFeatures).forEach(plan => {
                const isCurrent = state.selectedPlan === plan.name;
                const isFeatured = plan.name === 'Max';
                const featuresHTML = plan.features.map(f => `<li class="flex items-start"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 text-blue-400 mr-3 mt-1 flex-shrink-0"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg><span>${f}</span></li>`).join('');
                const card = document.createElement('div');
                card.className = `border rounded-2xl p-6 sm:p-8 flex flex-col ${isCurrent ? 'border-blue-500' : 'border-gray-800'} ${isFeatured ? 'bg-gray-900/80' : 'bg-gray-900/50'}`;
                card.innerHTML = `
                    ${isFeatured ? `<div class="text-center mb-4"><span class="bg-gradient-to-bl from-[#00298a] to-[#0091ff] text-white text-xs font-bold px-3 py-1 rounded-full">MOST POWERFUL</span></div>` : ''}
                    <h3 class="text-xl sm:text-2xl font-bold text-center">${plan.name}</h3>
                    <div class="text-center mt-4">
                        <span class="text-4xl sm:text-5xl font-extrabold">$${plan.price}</span>
                        <span class="text-gray-400">/month</span>
                    </div>
                    <ul class="mt-8 space-y-4 text-gray-300 flex-grow text-sm sm:text-base">${featuresHTML}</ul>
                    <button data-plan="${plan.name}" class="select-plan-button w-full mt-8 py-3 px-6 font-bold rounded-lg transition-colors ${ isCurrent ? 'bg-gray-700 text-gray-400 cursor-not-allowed' : 'bg-gradient-to-bl from-[#00298a] to-[#0091ff] text-white hover:opacity-90' }" ${isCurrent ? 'disabled' : ''}>
                        ${isCurrent ? 'Current Plan' : 'Select Plan'}
                    </button>
                `;
                pricingContainer.appendChild(card);
            });
            document.getElementById('pricing-back-button').addEventListener('click', () => handleNavigate('dashboard'));
            document.querySelectorAll('.select-plan-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    state.selectedPlan = btn.dataset.plan;
                    handleNavigate('dashboard');
                });
            });
        }

        function render() {
            Object.values(views).forEach(v => v.classList.add('hidden'));
            if (views[state.currentView]) {
                views[state.currentView].classList.remove('hidden');
            }

            headerPlanBadge.textContent = state.selectedPlan;
            headerPlanBadge.className = `px-3 py-1 text-xs sm:text-sm font-semibold rounded-full ${state.selectedPlan === 'Max' || state.selectedPlan === 'Pro' ? 'bg-gradient-to-bl from-[#00298a] to-[#0091ff] text-white' : 'bg-gray-700 text-gray-200'}`;

            switch (state.currentView) {
                case 'advisor': renderAdvisorView(); break;
                case 'goals': renderGoalsView(); break;
                case 'businessBuilder': renderBusinessBuilderView(); break;
                case 'market': renderMarketView(); break;
                case 'pricing': renderPricingView(); break;
            }
        }
        
        // --- INITIALIZATION ---
        function init() {
            document.querySelectorAll('.dashboard-action-button').forEach(button => {
                button.addEventListener('click', () => handleNavigate(button.dataset.view));
            });
            document.querySelectorAll('.header-nav-button').forEach(button => {
                button.addEventListener('click', () => handleNavigate(button.dataset.view));
            });
            document.getElementById('dashboard-query-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const query = e.target.elements.customQuery.value;
                if(query) {
                    handleNavigate('advisor');
                    setTimeout(() => handleGenerateResponse(query, 'chat'), 10);
                }
            });
            document.getElementById('logo-button').addEventListener('click', () => handleNavigate('dashboard'));
            document.getElementById('pricing-button').addEventListener('click', () => handleNavigate('pricing'));
            
            // Demo notification
            setTimeout(() => {
                showNotification("Congratulations! You've reached your monthly goal!");
            }, 2000);

            render();
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>


